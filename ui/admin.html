<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Admin Paneli | Guide of Dubai B2B</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-red: #e30613;
            --primary-red-hover: #b3050f;
        }
        
        .header {
            background: var(--primary-red);
            color: white;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary-red);
            margin-bottom: 1.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-red);
        }
        
        .btn-primary {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-red-hover);
            border-color: var(--primary-red-hover);
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-processing { background-color: #cce7ff; color: #004085; }
        .status-approved { background-color: #d4edda; color: #155724; }
        .status-rejected { background-color: #f8d7da; color: #721c24; }

        .alert-info {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            color: #1976D2;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-shield-alt me-2"></i>Admin Paneli</h2>
            <button class="btn btn-light" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>√áƒ±kƒ±≈ü
            </button>
        </div>
    </div>



        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalApplications">0</div>
                    <div>Toplam Ba≈üvuru</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="pendingApplications">0</div>
                    <div>Bekleyen Ba≈üvuru</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div>Toplam Kullanƒ±cƒ±</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="approvedApplications">0</div>
                    <div>Onaylanan Ba≈üvuru</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#applications">Ba≈üvurular</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#users">Kullanƒ±cƒ±lar</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#logs">Giri≈ü Loglarƒ±</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Applications Tab -->
            <div class="tab-pane fade show active" id="applications">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5>T√ºm Ba≈üvurular</h5>
                        <button class="btn btn-primary btn-sm" onclick="exportToCSV('applications')">
                            <i class="fas fa-download"></i> CSV ƒ∞ndir
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ad Soyad</th>
                                        <th>Email</th>
                                        <th>Telefon</th>
                                        <th>Vize Tipi</th>
                                        <th>Durum</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Y√ºkleniyor...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-pane fade" id="users">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5>Sistem Kullanƒ±cƒ±larƒ±</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#userModal">
                            <i class="fas fa-plus"></i> Yeni Kullanƒ±cƒ±
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ad Soyad</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Y√ºkleniyor...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-pane fade" id="logs">
                <div class="card">
                    <div class="card-header">
                        <h5>Giri≈ü Loglarƒ±</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Tarih/Saat</th>
                                        <th>Kullanƒ±cƒ± ID</th>
                                        <th>IP Adresi</th>
                                        <th>Durum</th>
                                        <th>Tip</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTable">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Y√ºkleniyor...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yeni Kullanƒ±cƒ± Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <label class="form-label">Ad Soyad</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">≈ûifre</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rol</label>
                            <select class="form-select" name="role" required>
                                <option value="staff">Staff</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // üöÄ RENDER BACKEND URL - T√úM API √áAƒûRILARI BURAYA Gƒ∞DECEK
        const API_BASE_URL = 'https://god-1-lsu5.onrender.com';
        
        let authToken = localStorage.getItem('token');
        let applications = [];
        let users = [];
        let logs = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîó Backend URL:', API_BASE_URL);
            checkAuth();
            loadData();
        });

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionBadge');
            if (connected) {
                badge.textContent = 'Baƒülƒ±';
                badge.className = 'badge bg-success ms-2';
            } else {
                badge.textContent = 'Baƒülantƒ± Hatasƒ±';
                badge.className = 'badge bg-danger ms-2';
            }
        }

        function checkAuth() {
            if (!authToken) {
                alert('L√ºtfen √∂nce giri≈ü yapƒ±n!');
                window.location.href = 'https://god-1-lsu5.onrender.com/sign-in.html';
                return;
            }

            console.log('üîí Token kontrol√º yapƒ±lƒ±yor...');
            
            // Token doƒürulama - RENDER BACKEND'E ƒ∞STEK
            fetch(`${API_BASE_URL}/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('‚úÖ Auth response:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üë§ User data:', data);
                updateConnectionStatus(true);
                
                if (data.role !== 'admin') {
                    alert('Bu sayfaya sadece admin kullanƒ±cƒ±larƒ± eri≈üebilir!');
                    window.location.href = `${API_BASE_URL}/sign-in.html`;
                    return;
                }
                
                console.log('‚úÖ Admin yetkisi doƒürulandƒ±');
            })
            .catch(error => {
                console.error('‚ùå Auth error:', error);
                updateConnectionStatus(false);
                alert('Giri≈ü token\'ƒ± ge√ßersiz. L√ºtfen tekrar giri≈ü yapƒ±n.');
                localStorage.removeItem('token');
                window.location.href = `${API_BASE_URL}/sign-in.html`;
            });
        }

        function loadData() {
            console.log('üìä Veriler y√ºkleniyor...');
            loadApplications();
            loadUsers();
            loadLogs();
        }

        // RENDER BACKEND'DEN ba≈üvurularƒ± y√ºkle
        function loadApplications() {
            console.log('üìã Ba≈üvurular y√ºkleniyor...');
            
            fetch(`${API_BASE_URL}/applications`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Ba≈üvurular y√ºklendi:', data.length);
                applications = data || [];
                renderApplicationsTable();
                updateStats();
            })
            .catch(error => {
                console.error('‚ùå Ba≈üvuru y√ºkleme hatasƒ±:', error);
                document.getElementById('applicationsTable').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">‚ùå Ba≈üvurular y√ºklenirken hata olu≈ütu</td></tr>';
            });
        }

        // RENDER BACKEND'DEN kullanƒ±cƒ±larƒ± y√ºkle
        function loadUsers() {
            console.log('üë• Kullanƒ±cƒ±lar y√ºkleniyor...');
            
            fetch(`${API_BASE_URL}/users`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Kullanƒ±cƒ±lar y√ºklendi:', data.length);
                users = data || [];
                renderUsersTable();
                updateStats();
            })
            .catch(error => {
                console.error('‚ùå Kullanƒ±cƒ± y√ºkleme hatasƒ±:', error);
                document.getElementById('usersTable').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">‚ùå Kullanƒ±cƒ±lar y√ºklenirken hata olu≈ütu</td></tr>';
            });
        }

        // RENDER BACKEND'DEN loglarƒ± y√ºkle
        function loadLogs() {
            console.log('üìú Loglar y√ºkleniyor...');
            
            fetch(`${API_BASE_URL}/logs`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Loglar y√ºklendi:', data.length);
                logs = data || [];
                renderLogsTable();
            })
            .catch(error => {
                console.error('‚ùå Log y√ºkleme hatasƒ±:', error);
                document.getElementById('logsTable').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">‚ùå Loglar y√ºklenirken hata olu≈ütu</td></tr>';
            });
        }

        function renderApplicationsTable() {
            const tbody = document.getElementById('applicationsTable');
            
            if (!applications || applications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">üìù Hen√ºz ba≈üvuru bulunmuyor</td></tr>';
                return;
            }
            
            tbody.innerHTML = applications.map(app => `
                <tr>
                    <td>#${app.id}</td>
                    <td>${app.ad || ''} ${app.soyad || ''}</td>
                    <td>${app.email || ''}</td>
                    <td>${app.telefon || ''}</td>
                    <td>${app.vize_tipi || ''}</td>
                    <td><span class="status-badge status-${app.status}">${getStatusText(app.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewApplication(${app.id})" title="G√∂r√ºnt√ºle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication(${app.id})" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">üë• Hen√ºz kullanƒ±cƒ± bulunmuyor</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>#${user.id}</td>
                    <td>${user.name || ''}</td>
                    <td>${user.email || ''}</td>
                    <td><span class="badge bg-${user.role === 'admin' ? 'danger' : 'primary'}">${user.role || ''}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="editUserRole(${user.id}, '${user.role}')" title="Rol Deƒüi≈ütir">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderLogsTable() {
            const tbody = document.getElementById('logsTable');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">üìú Hen√ºz log kaydƒ± bulunmuyor</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.log_time || ''}</td>
                    <td>User #${log.user_id || 'N/A'}</td>
                    <td>${log.ip || ''}</td>
                    <td><span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">${log.status === 'success' ? 'Ba≈üarƒ±lƒ±' : 'Ba≈üarƒ±sƒ±z'}</span></td>
                    <td><span class="badge bg-${log.user_type === 'admin' ? 'danger' : 'primary'}">${log.user_type || ''}</span></td>
                </tr>
            `).join('');
        }

        // Frontend'de istatistikleri hesapla
        function updateStats() {
            document.getElementById('totalApplications').textContent = applications.length;
            document.getElementById('pendingApplications').textContent = applications.filter(app => app.status === 'pending').length;
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('approvedApplications').textContent = applications.filter(app => app.status === 'approved').length;
        }

        // RENDER BACKEND'E ba≈üvuru silme isteƒüi
        function deleteApplication(id) {
            if (confirm('Bu ba≈üvuruyu silmek istediƒüinizden emin misiniz?')) {
                console.log('üóëÔ∏è Ba≈üvuru siliniyor:', id);
                
                fetch(`${API_BASE_URL}/applications/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    console.log('‚úÖ Ba≈üvuru silindi');
                    alert('Ba≈üvuru ba≈üarƒ±yla silindi!');
                    loadApplications(); // Tabloyu yenile
                })
                .catch(error => {
                    console.error('‚ùå Silme hatasƒ±:', error);
                    alert('Silme i≈ülemi ba≈üarƒ±sƒ±z!');
                });
            }
        }

        // RENDER BACKEND'E kullanƒ±cƒ± silme isteƒüi
        function deleteUser(id) {
            if (confirm('Bu kullanƒ±cƒ±yƒ± silmek istediƒüinizden emin misiniz?')) {
                console.log('üóëÔ∏è Kullanƒ±cƒ± siliniyor:', id);
                
                fetch(`${API_BASE_URL}/users/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    console.log('‚úÖ Kullanƒ±cƒ± silindi');
                    alert('Kullanƒ±cƒ± ba≈üarƒ±yla silindi!');
                    loadUsers(); // Tabloyu yenile
                })
                .catch(error => {
                    console.error('‚ùå Silme hatasƒ±:', error);
                    alert('Silme i≈ülemi ba≈üarƒ±sƒ±z!');
                });
            }
        }

        // RENDER BACKEND'E kullanƒ±cƒ± rol g√ºncelleme isteƒüi
        function editUserRole(id, currentRole) {
            const newRole = currentRole === 'admin' ? 'staff' : 'admin';
            if (confirm(`Kullanƒ±cƒ± rol√ºn√º ${newRole} olarak deƒüi≈ütirmek istediƒüinizden emin misiniz?`)) {
                console.log('üîÑ Rol g√ºncelleniyor:', id, newRole);
                
                fetch(`${API_BASE_URL}/users/${id}/role`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ Rol g√ºncellendi:', data);
                    alert('Kullanƒ±cƒ± rol√º ba≈üarƒ±yla g√ºncellendi!');
                    loadUsers(); // Tabloyu yenile
                })
                .catch(error => {
                    console.error('‚ùå Rol g√ºncelleme hatasƒ±:', error);
                    alert('Rol g√ºncelleme ba≈üarƒ±sƒ±z!');
                });
            }
        }

        // RENDER BACKEND'E yeni kullanƒ±cƒ± ekleme isteƒüi
        function saveUser() {
            const form = document.getElementById('userForm');
            const formData = new FormData(form);
            
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            };

            console.log('‚ûï Yeni kullanƒ±cƒ± ekleniyor:', userData.email);

            fetch(`${API_BASE_URL}/users`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
                console.log('‚úÖ Kullanƒ±cƒ± eklendi');
                alert('Kullanƒ±cƒ± ba≈üarƒ±yla eklendi!');
                
                // Modal'ƒ± kapat
                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                modal.hide();
                
                // Formu temizle
                form.reset();
                
                // Tabloyu yenile
                loadUsers();
            })
            .catch(error => {
                console.error('‚ùå Kullanƒ±cƒ± ekleme hatasƒ±:', error);
                alert('Kullanƒ±cƒ± ekleme ba≈üarƒ±sƒ±z: ' + error.message);
            });
        }

        function viewApplication(id) {
            // Ba≈üvuru detaylarƒ± yeni sekmede a√ß
            window.open(`${API_BASE_URL}/application-details.html?id=${id}`, '_blank');
        }

        // Basit CSV export
        function exportToCSV(type) {
            if (type === 'applications') {
                if (!applications || applications.length === 0) {
                    alert('Export edilecek ba≈üvuru bulunamadƒ±!');
                    return;
                }
                
                const headers = ['ID', 'Ad', 'Soyad', 'Email', 'Telefon', 'Vize Tipi', 'Durum'];
                const csvContent = [
                    headers.join(','),
                    ...applications.map(app => [
                        app.id,
                        app.ad || '',
                        app.soyad || '',
                        app.email || '',
                        app.telefon || '',
                        app.vize_tipi || '',
                        app.status || ''
                    ].join(','))
                ].join('\n');
                
                downloadCSV(csvContent, 'basvurular.csv');
            }
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Bekleyen',
                'processing': 'ƒ∞≈ülemde',
                'approved': 'Onaylandƒ±',
                'rejected': 'Reddedildi',
                'cancelled': 'ƒ∞ptal Edildi'
            };
            return statusTexts[status] || status;
        }

        function logout() {
            localStorage.removeItem('token');
            alert('√áƒ±kƒ±≈ü yapƒ±ldƒ±!');
            window.location.href = `${API_BASE_URL}/sign-in.html`;
        }
    </script>
</body>
</html>